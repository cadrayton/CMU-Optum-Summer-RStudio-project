---
title: 'EDA Project: Hospital Ratings data'
output: html_document
---

## Overview

This project will begin on Monday June 13th, and __conclude with a 10-15 minute presentation on Friday, June 24th (either during the morning session from 10:30 to 12 PM or in the afternoon from 1:30 to 3 PM)__. The goal of this project is to practice understanding the structure of a dataset, and to practice generating and evaluating hypotheses using fundamental EDA and data visualization techniques.

## Deliverables

Your team is expected to produce `R Markdown` slides (an example template will be provided shortly) to accompany your 10-15 minute presentation with the following information:

* Explanation of the data structure of the dataset,

* __Three hypotheses__ you are interested in exploring,

* __Three data visualizations__ exploring the hypotheses, at least two of which must be multivariate.  __Each visualization must be in a different format__ from the other two, and you must have at least one categorical and one continuous visualization.

* __One clustering example__,

* Conclusions reached for the hypotheses based on your EDA and data visualizations.

## Timeline

There will be two submission deadlines:

**Friday, June 17th @ 5:00 PM EST** - Each student will push their individual code for the project thus far to their GitHub accounts for review. We will then provide feedback on the code submitted.

**Thursday, June 23rd @ 11:59 PM EST** - Slides and full code must be completed and ready for presentation. Send your slides to Prof Yurko's email ([ryurko@andrew.cmu.edu](mailto:ryurko@andrew.cmu.edu)).  All code, visualizations, and presentations must be made in `R`. Take advantage of examples from lecture and the presentation template, but also feel free to explore material online that may be relevant!


## Data

Your team is assigned the [__Hospital ratings data__](http://www.stat.cmu.edu/cmsac/sure/2022/materials/data/health/eda_projects/hospitals.csv). This dataset was curated by the [CORGIS Dataset Project](https://corgis-edu.github.io/corgis/csv/hospitals/) to: _"allow consumers to directly compare across hospitals performance measure information related to heart attack, emergency department care, preventive care, stroke care, and other conditions. The data is part of an Administration-wide effort to increase the availability and accessibility of information on quality, utilization, and costs for effective, informed decision-making."_ Original source of data located [here](https://data.medicare.gov/data/hospital-compare).

Each row of the dataset corresponds to a single hospital and has the following columns (with definitions borrowed the [online glossary](https://corgis-edu.github.io/corgis/csv/hospitals/):

* `Facility.Name`: Name of the hospital
* `Facility.City`: City in which the hospital is located
* `Facility.State`: Two letter capitalized abbreviation of the State in which the hospital is located (e.g., AZ is Arizona)
* `Facility.Type`: Kind of organization operating the hospital: one of Government, Private, Proprietary, Church, or Unknown
* `Rating.Overall`: Overall rating between 1 and 5 stars, with 5 stars being the highest rating; -1 represents no rating.	
* `Rating.Mortality`: Above, Same, Below, or Unknown comparison to national hospital mortality
* `Rating.Safety`: Above, Same, Below, or Unknown comparison to national hospital safety
* `Rating.Readmission`: Above, Same, Below, or Unknown comparison to national hospital readmission
* `Rating.Experience`: Above, Same, Below, or Unknown comparison to national hospital patience experience
* `Rating.Effectiveness`: Above, Same, Below, or Unknown comparison to national hospital effectiveness of care
* `Rating.Timeliness`: Above, Same, Below, or Unknown comparison to national hospital timeliness of care
* `Rating.Imaging`:	Above, Same, Below, or Unknown comparison to national hospital effective use of imaging
* `Procedure.Heart Attack.Cost`: Average cost of care for heart attacks
* `Procedure.Heart Attack.Quality`: Lower, Average, Worse, or Unknown comparison to national quality of care for heart attacks
* `Procedure.Heart Attack.Value`: Lower, Average, Worse, or Unknown comparison to national cost of care for heart attacks
* `Procedure.Heart Failure.Cost`: Average cost of care for heart failure
* `Procedure.Heart Failure.Quality`: Lower, Average, Worse, or Unknown comparison to national quality of care for heart failures
* `Procedure.Heart Failure.Value`: Lower, Average, Worse, or Unknown comparison to national cost of care for heart failures
* `Procedure.Pneumonia.Cost`: Average cost of care for pneumonia
* `Procedure.Pneumonia.Quality`: Lower, Average, Worse, or Unknown comparison to national quality of care for pneumonia
* `Procedure.Pneumonia.Value`: Lower, Average, Worse, or Unknown comparison to national cost of care for pneumonia
* `Procedure.Hip Knee.Cost`: Average cost of care for hip or knee conditions
* `Procedure.Hip Knee.Quality`: Lower, Average, Worse, or Unknown comparison to national quality of care for hip or knee conditions
* `Procedure.Hip Knee.Value`: Lower, Average, Worse, or Unknown comparison to national cost of care for hip or knee conditions

```{r}

ratings <- read_csv("http://www.stat.cmu.edu/cmsac/sure/2022/materials/data/health/eda_projects/hospitals.csv")
head(ratings)
dim(ratings)
summary(ratings)
str(ratings)
tail(ratings, 3)

```



1655142140231:rating %>%
1655142140233:corr(facility.type, rating.overall)
1655142157271:ratings %>%
1655142157273:corr(facility.type, rating.overall)
1655142222611:ratings %>%
cor.test(facility.type, rating.overall, method = "pearson")
1655142245716:ratings %>%
1655142245723:cor.test(facility.type, Rating.Overall, method = "pearson")
1655142261179:ratings %>%
1655142261182:cor.test(facility.type, Rating.Mortality, method = "pearson")
1655142284188:cor.test(ratings$facility.type, ratings$Rating.Mortality, method = "pearson")
1655142304073:cor.test(ratings$facility.type, ratings$rating.mortality, method = "pearson")
1655142321244:str(ratings)
1655142384268:ratings %>%
1655142384271:cor.test(ratings$`Procedure.Heart Attack.Cost`, ratings$`Procedure.Heart Failure.Cost`, method = "pearson")
1655142394711:cor.test(ratings$`Procedure.Heart Attack.Cost`, ratings$`Procedure.Heart Failure.Cost`, method = "pearson")
1655142474931:summary(ratings)

```{r}

ratings %>%
  group_by(Facility.Type) %>%
  summarize(mean(`Procedure.Heart Attack.Cost`), min(`Procedure.Heart Attack.Cost`), max(`Procedure.Heart Attack.Cost`))

summary(ratings)
```

1655142475114:
1655142763270:ratings %>%
1655142763278:group_by(Facility.Type) %>%
1655142763283:summarize(mean(`Procedure.Heart Attack.Cost`), max(`Procedure.Heart Attack.Cost`))
1655142935779:summary(ratings)
1655142935941:ratings %>%
1655142935946:group_by(Facility.Type) %>%
1655142935950:summarize(mean(`Procedure.Heart Attack.Cost`), max(`Procedure.Heart Attack.Cost`))
1655142936021:ratings %>%
1655142936025:group_by(Facility.Type) %>%
1655142936029:summarize(mean(`Procedure.Heart Failure.Cost`), max(`Procedure.Heart Failure.Cost`))
1655142936063:ratings %>%
1655142936068:group_by(Facility.Type) %>%
1655142936073:summarize(mean(`Procedure.Pneumonia.Cost`), max(`Procedure.Pneumonia.Cost`))
1655142936112:ratings %>%
1655142936114:group_by(Facility.Type) %>%
1655142936117:summarize(mean(`Procedure.Hip Knee.Cost`), max(`Procedure.Hip Knee.Cost`))
1655143142291:arrange(ratings, Facility.Type, Rating.Overall)

```{r}
ratings %>%
  group_by(Facility.Type) %>%
  summarize(mean(`Procedure.Hip Knee.Cost`), max(`Procedure.Hip Knee.Cost`))

```


```{r}
ratings %>%
  ggplot(aes(x = `Procedure.Heart Attack.Value`, y = `Procedure.Heart Attack.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Heart Attack Value", y = "Heart Attack Cost of Care",
       color = "Facility Type") +
  theme_bw()
```

1655143521374:table(rating.readmission)
```{r}

table(ratings$Rating.Readmission)

ratings %>%
  ggplot(aes(x = Rating.Readmission))+
  geom_histogram() +
  theme_bw()

ratings %>%
  ggplot(aes(x = Rating.Readmission))+
  geom_bar() +
  theme_bw()

table(ratings$Rating.Readmission)

ratings %>%
  ggplot(aes(x = `Procedure.Heart Attack.Value`, y = `Procedure.Heart Attack.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Heart Attack Value", y = "Heart Attack Cost of Care",
       color = "Facility Type") +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Heart Failure.Value`, y = `Procedure.Heart Failure.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Heart Failure Value", y = "Heart Failure Cost of Care",
       color = "Facility Type") +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Pneumonia.Value`, y = `Procedure.Pneumonia.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Pneumonia Value", y = "Pneumonia Cost of Care",
       color = "Facility Type") +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Hip Knee.Value`, y = `Procedure.Hip Knee.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Hip Knee Value", y = "Hip Knee Cost of Care",
       color = "Facility Type") +
  theme_bw()
```

```{r}

ratings %>%
  ggplot(aes(x = `Procedure.Pneumonia.Value`, y = `Procedure.Pneumonia.Cost`,
             color = Facility.State)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Pneumonia Value", y = "Pneumonia Cost of Care",
       color = "Facility Type") +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Pneumonia.Value`, y = `Procedure.Pneumonia.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Pneumonia Value", y = "Pneumonia Cost of Care",
       color = "Facility Type") +
  theme_bw()
```

```{r}
View(ratings)

ratings %>%
  ggplot(aes(x = `Procedure.Hip Knee.Value`, y = `Procedure.Hip Knee.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Hip Knee Value", y = "Hip Knee Cost of Care",
       color = "Facility Type") +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Hip Knee.Value`, y = `Procedure.Hip Knee.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 0.5) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Hip Knee Value", y = "Hip Knee Cost of Care",
       color = "Facility Type") +
  theme_bw()

str(ratings)


ratings %>%
  ggplot(aes(x = `Procedure.Hip Knee.Value`, y = `Procedure.Hip Knee.Cost`,
             color = Facility.Type)) +
  geom_point(alpha = 2) +
  scale_color_brewer(palette = "Set4") +
  labs(x = "Hip Knee Value", y = "Hip Knee Cost of Care",
       color = "Facility Type") +
  theme_bw()
```

```{r}
install.packages("maps")
install.packages("mapdata")
library(maps)
library(mapdata)
library(maps)
usa <- map_data('usa')
usa
ggplot(usa)
library(usmap)
install.packages("usmap")
library(usmap)
plot_usmap(states = Facility.State) +
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))

```

```{r}

ratings %>%
  ggplot(aes(x = `Procedure.Heart Failure.Cost`, y = `Procedure.Heart Attack.Cost`)) +
  geom_point(alpha = 0.75) +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Heart Failure.Cost`, y = `Procedure.Heart Attack.Cost`)) +
  geom_point(alpha = 0.75) +
  theme_bw()

table(ratings$Facility.Type, ratings$Facility.Type)
table(ratings$Facility.Type, ratings$avg(Rating.Overall))

ratings %>%
  group_by(Facility.Type) %>%
  summarize(mean(Rating.Overall)) %>%
  ggplot(aes(x = Facility.Type, y = mean(Rating.Overall))) +
  geom_bar() +
  theme_bw()

ratings %>%
  ggplot(aes(x = Facility.Type, y = mean(Rating.Overall))) +
  geom_bar() +
  theme_bw()

ratings %>%
  ggplot(aes(x = Facility.Type, y = mean(Rating.Overall))) +
  geom_histogram() +
  theme_bw()

ratings %>%
  ggplot(aes(x = Facility.Type, y = mean(Rating.Overall))) +
  geom_point() +
  theme_bw()

ratings %>%
  ggplot(aes(x = Facility.Type, y = mean(Rating.Overall))) +
  geom_line() +
  theme_bw()

ratings %>%
  ggplot(aes(x = Facility.Type, y = mean(Rating.Overall))) +
  geom_line() +
  theme_bw()

ggplot(aes(x = Rating.Overall,
           fill = Facility.Type)) +
  geom_histogram(alpha = .5, position = "dodge") +
  theme_bw() + 
  theme(legend.position = "bottom")

ratings %>%
  ggplot(aes(x = avg(Rating.Experience),
             fill = Facility.Type)) +
  geom_bar(position = "dodge") + theme_bw()

ratings %>%
  ggplot(ratings, aes(x = `Procedure.Heart Attack.Value`,
                      y = `Procedure.Heart Attack.Cost`)) +
  geom_point() +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 2)
```

```{r}
#Density Curves

ratings %>%
  ggplot(aes(x = `Procedure.Heart Attack.Cost`)) +
  geom_density(adjust = 3) +
  geom_rug(alpha = 0.5) +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Heart Failure.Cost`)) +
  geom_density(adjust = 3) +
  geom_rug(alpha = 0.5) +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Pneumonia.Cost`)) +
  geom_density(adjust = 3) +
  geom_rug(alpha = 0.5) +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Hip Knee.Cost`)) +
  geom_density(adjust = 3) +
  geom_rug(alpha = 0.5) +
  theme_bw()

ratings %>%
  ggplot(aes(x = `Procedure.Heart Attack.Value`,
             y = `Procedure.Heart Attack.Cost`)) +
  geom_density_ridges()

ratings %>%
  ggplot(aes(x = `Procedure.Pneumonia.Value`, y = `Procedure.Pneumonia.Cost`)) +
  geom_point() +
  facet_wrap(~ Facility.Type, nrow = 2) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Pneumonia Value", y = "Pneumonia Cost of Care",
       color = "Facility Type") +
  theme_bw()


#Mean HeartAttack Cost 
state.by <- ratings %>% group_by(Facility.State)

state_heart <- state.by %>% summarise(mean_cost = mean(`Procedure.Heart Attack.Cost`))

colnames(state_heart)[1] <- 'state'

plot_usmap(data = state_heart, values = "mean_cost", color = "red")

#Mean Rating.Overall
state.by <- ratings %>% group_by(Facility.State)
state_heart <- state.by %>% summarise(mean_rating = mean(Rating.Overall))
colnames(state_heart)[1] <- 'state'

plot_usmap(data = state_heart, values = "mean_rating", color = "red") +
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))


plot_usmap(data = state_heart, values = "mean_cost", color = "red") +
  scale_fill_continuous(low = 'white', high = 'red')

#all_cost
plot_usmap(data = state_heart, values = "all_cost", color = "red") +
  scale_fill_continuous(low = 'white', high = 'red')


ratings %>%
  mutate(all_cost = mean(`Procedure.Heart Attack.Cost`, `Procedure.Heart Failure.Cost`, `Procedure.Pneumonia.Cost`, `Procedure.Hip Knee.Cost`))

ratings %>%
  mutate(all_cost = sum(`Procedure.Heart Attack.Cost`, `Procedure.Heart Failure.Cost`, `Procedure.Pneumonia.Cost`, `Procedure.Hip Knee.Cost`))

ratings %>%
  mutate(all_cost = sum(`Procedure.Heart Attack.Cost`, `Procedure.Heart Failure.Cost`, `Procedure.Pneumonia.Cost`, `Procedure.Hip Knee.Cost`) / 4)

ratings %>%
  mutate(all_cost = (`Procedure.Heart Attack.Cost` + `Procedure.Heart Failure.Cost` + `Procedure.Pneumonia.Cost` + `Procedure.Hip Knee.Cost` / 4))

ratings <- ratings %>%
  mutate(all_cost = (`Procedure.Heart Attack.Cost` + `Procedure.Heart Failure.Cost` + `Procedure.Pneumonia.Cost` + `Procedure.Hip Knee.Cost` / 4))

ratings <- ratings %>%
  mutate(all_cost = (`Procedure.Heart Attack.Cost` + `Procedure.Heart Failure.Cost` + `Procedure.Pneumonia.Cost` + `Procedure.Hip Knee.Cost` / 4))

# all_cost across all 4 procedures
state.by <- ratings %>% group_by(Facility.State)
state_heart <- state.by %>% summarise(mean_cost = all_cost)

state.by <- ratings %>% group_by(Facility.State)
state_heart <- state.by %>% summarise(all_cost = all_cost)
colnames(state_heart)[1] <- 'state'

plot_usmap(data = state_heart, values = "all_cost", color = "red") +
  scale_fill_continuous(low = 'white', high = 'red')

calculate_mode <- function(x) {
  uniqx <- unique(x)
  uniqx[which.max(tabulate(match(x,uniqx)))]
}
ratings %>%
  group_by(Facility.State) %>%
  summarise(color_map = calculate_mode(`Procedure.Heart Attack.Quality`))

ratings %>%
  mutate()

ratings %>%
  mutate(color_map = calculate_mode(`Procedure.Heart Attack.Quality`))

state.by <- ratings %>% group_by(Facility.State)
state_heart <- state.by %>% summarise(mean_cost = color_map)
colnames(state_heart)[1] <- 'state'


plot_usmap(data = state_heart, values = "color_map", color = "red") +
  scale_fill_continuous(low = 'white', high = 'red')


  



```
Hypothesis:

1. Facility Type correlates with Rating Overall

2. Facility state correlates with the overall cost

3. Facility State correlates with cost/quality 
